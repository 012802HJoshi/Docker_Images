pipeline {
    agent any

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Create Environment File') {
            steps {
                script {
                    withCredentials([file(credentialsId: 'ENV_MONGO_DB', variable: 'ENV')]) {
                        sh '''
                            echo "✅ Creating .env for MongoDB..."

                            mkdir -p Database/MongoDB
                            cp $ENV Database/MongoDB/.env

                            chown jenkins:jenkins Database/MongoDB/.env
                            chmod 600 Database/MongoDB/.env

                            echo "✅ .env successfully placed in Database/MongoDB"
                        '''
                    }
                }
            }
        }

        stage('Docker Info') {
            steps {
                sh 'docker --version'
                sh 'docker compose version'
            }
        }

        stage('Create Network If Not Exists') {
            steps {
                sh '''
                    echo "✅ Loading ENV..."
                    set -a
                    source Database/MongoDB/.env
                    set +a

                    echo "✅ Required network: db-network-mongo"

                    if ! docker network ls | grep -q db-network-mongo; then
                        echo "✅ Creating Docker network: db-network-mongo"
                        docker network create db-network-mongo
                    else
                        echo "✅ Docker network already exists"
                    fi
                '''
            }
        }


        stage('Start MongoDB') {
            steps {
                sh '''
                    echo "✅ Starting MongoDB using Docker Compose..."
                    cd Database/MongoDB
                     docker compose pull "$CONTAINER_NAME"
                     docker compose down
                     docker compose up -d --force-recreate
                    echo "✅ MongoDB started"
                '''
            }
        }

        stage('Verify MongoDB') {
            steps {
                sh '''
                    docker ps | grep "$CONTAINER_NAME" || (echo "❌ MongoDB not running" && exit 1)
                '''
            }
        }
    }

    post {
        success {
            echo "✅✅✅ MongoDB Pipeline Completed Successfully ✅✅✅"
        }
        failure {
            echo "❌❌❌ MongoDB Pipeline Failed ❌❌❌"
        }
    }
}
